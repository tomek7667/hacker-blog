<footer>
	<div class="footer-content">
		<div class="social-links">
			<a
				href="https://github.com/tomek7667"
				class="social-link"
				aria-label="GitHub"
				target="_blank"
				rel="noopener"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					viewBox="0 0 24 24"
					fill="currentColor"
				>
					<path
						d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
					/>
				</svg>
			</a>
			<a
				href="https://x.com/_tomek7667"
				class="social-link"
				aria-label="X"
				target="_blank"
				rel="noopener"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					viewBox="0 0 24 24"
					fill="currentColor"
				>
					<path
						d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"
					/>
				</svg>
			</a>
			<a
				href="https://ctftime.org/team/33893"
				class="social-link"
				aria-label="CTFtime"
				target="_blank"
				rel="noopener"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					viewBox="0 0 24 24"
					fill="currentColor"
				>
					<path
						d="M4 4h16v2H4V4zm0 4h16v2H4V8zm0 4h10v2H4v-2zm0 4h16v2H4v-2zm14-4l4 4-4 4v-8z"
					/>
				</svg>
			</a>
			<a
				href="mailto:{{ site.author.email }}"
				class="social-link"
				aria-label="Email"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
				>
					<path
						d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"
					/>
					<polyline points="22,6 12,13 2,6" />
				</svg>
			</a>
			<a href="/atom.xml" class="social-link" aria-label="RSS Feed">
				<svg
					xmlns="http://www.w3.org/2000/svg"
					viewBox="0 0 24 24"
					fill="currentColor"
				>
					<circle cx="6.18" cy="17.82" r="2.18" />
					<path
						d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"
					/>
				</svg>
			</a>
		</div>
		<p class="footer-text">
			{{ site.owner }} &copy; {% capture currentyear %}{{ 'now' | date: "%Y"
			}}{% endcapture %}{{ currentyear }}
		</p>
	</div>
</footer>

<button class="scroll-top" onclick="scrollToTop()" aria-label="Scroll to top">
	<svg
		xmlns="http://www.w3.org/2000/svg"
		width="24"
		height="24"
		viewBox="0 0 24 24"
		fill="none"
		stroke="currentColor"
		stroke-width="2"
		stroke-linecap="round"
		stroke-linejoin="round"
	>
		<polyline points="18 15 12 9 6 15"></polyline>
	</svg>
</button>

<div class="lightbox" onclick="closeLightbox()">
	<img src="" alt="Enlarged image" />
</div>

<script>
	function toggleTheme() {
		const html = document.documentElement;
		const currentTheme = html.getAttribute("data-theme");
		const newTheme = currentTheme === "dark" ? "light" : "dark";
		html.setAttribute("data-theme", newTheme);
		localStorage.setItem("theme", newTheme);
		updateThemeIcon(newTheme);
	}

	function updateThemeIcon(theme) {
		const sunIcon = document.querySelector(".sun-icon");
		const moonIcon = document.querySelector(".moon-icon");
		if (theme === "dark") {
			sunIcon.style.display = "block";
			moonIcon.style.display = "none";
		} else {
			sunIcon.style.display = "none";
			moonIcon.style.display = "block";
		}
	}

	document.addEventListener("DOMContentLoaded", function () {
		const theme = localStorage.getItem("theme") || "dark";
		updateThemeIcon(theme);
	});

	function scrollToTop() {
		window.scrollTo({ top: 0, behavior: "smooth" });
	}

	window.addEventListener("scroll", function () {
		const scrollBtn = document.querySelector(".scroll-top");
		if (window.scrollY > 300) {
			scrollBtn.classList.add("visible");
		} else {
			scrollBtn.classList.remove("visible");
		}
	});

	document.addEventListener("DOMContentLoaded", function () {
		const images = document.querySelectorAll("article img, section img");
		const lightbox = document.querySelector(".lightbox");
		const lightboxImg = lightbox.querySelector("img");

		images.forEach((img) => {
			img.addEventListener("click", function () {
				lightboxImg.src = this.src;
				lightboxImg.alt = this.alt;
				lightbox.classList.add("active");
				document.body.style.overflow = "hidden";
			});
		});
	});

	function closeLightbox() {
		const lightbox = document.querySelector(".lightbox");
		lightbox.classList.remove("active");
		document.body.style.overflow = "";
	}

	document.addEventListener("keydown", function (e) {
		if (e.key === "Escape") {
			closeLightbox();
		}
	});

	document.addEventListener("DOMContentLoaded", function () {
		const codeBlocks = document.querySelectorAll("pre");

		codeBlocks.forEach((block) => {
			const wrapper = document.createElement("div");
			wrapper.className = "code-block-wrapper";
			block.parentNode.insertBefore(wrapper, block);
			wrapper.appendChild(block);

			const copyBtn = document.createElement("button");
			copyBtn.className = "copy-btn";
			copyBtn.textContent = "Copy";
			wrapper.appendChild(copyBtn);

			copyBtn.addEventListener("click", async function () {
				const code = block.querySelector("code") || block;
				await navigator.clipboard.writeText(code.textContent);
				copyBtn.textContent = "Copied!";
				copyBtn.classList.add("copied");
				setTimeout(() => {
					copyBtn.textContent = "Copy";
					copyBtn.classList.remove("copied");
				}, 2000);
			});
		});

		const links = document.querySelectorAll("article a, section a");
		links.forEach((link) => {
			if (link.classList.contains("internal-link")) return;
			const href = link.getAttribute("href");
			if (href && (href.startsWith("http") || href.startsWith("//"))) {
				if (!href.includes(window.location.hostname)) {
					link.setAttribute("target", "_blank");
					link.setAttribute("rel", "noopener noreferrer");
				}
			}
		});

		const viewsElements = document.querySelectorAll(".views-count");

		viewsElements.forEach(async (el) => {
			const page = el.dataset.page;
			const countEl = el.querySelector(".count");

			if (!page) return;

			try {
				const path = "/" + page;
				const res = await fetch(
					`https://tomek7667.goatcounter.com/counter/${encodeURIComponent(
						path
					)}.json`
				);

				if (res.ok) {
					const data = await res.json();
					countEl.textContent = data.count || "0";
					el.style.display = "flex";
				} else {
					el.style.display = "none";
				}
			} catch (e) {
				el.style.display = "none";
			}
		});
	});

	// Search functionality
	let searchData = null;
	let searchLoaded = false;

	async function loadSearchData() {
		if (searchLoaded) return;
		try {
			const res = await fetch("/search.json");
			searchData = await res.json();
			searchLoaded = true;
			populateTagFilter();
		} catch (e) {
			console.error("Failed to load search data:", e);
		}
	}

	function populateTagFilter() {
		const tagFilter = document.getElementById("tagFilter");
		if (!tagFilter || !searchData) return;

		const tags = new Set();
		searchData.forEach((post) => {
			if (post.tags) {
				post.tags.forEach((tag) => tags.add(tag));
			}
		});

		Array.from(tags)
			.sort()
			.forEach((tag) => {
				const option = document.createElement("option");
				option.value = tag;
				option.textContent = tag;
				tagFilter.appendChild(option);
			});
	}

	function toggleSearch() {
		const overlay = document.getElementById("searchOverlay");
		const input = document.getElementById("searchInput");

		if (overlay.classList.contains("active")) {
			overlay.classList.remove("active");
			document.body.style.overflow = "";
		} else {
			loadSearchData();
			overlay.classList.add("active");
			document.body.style.overflow = "hidden";
			setTimeout(() => input.focus(), 100);
			showSearchHint();
		}
	}

	function showSearchHint() {
		const results = document.getElementById("searchResults");
		results.innerHTML = `
			<div class="search-hint">
				<p>Search by title, content, tags, or difficulty</p>
				<p>Press <kbd>Esc</kbd> to close</p>
			</div>
		`;
	}

	function performSearch() {
		const query = document
			.getElementById("searchInput")
			.value.toLowerCase()
			.trim();
		const category = document
			.getElementById("categoryFilter")
			.value.toLowerCase();
		const difficulty = document
			.getElementById("difficultyFilter")
			.value.toLowerCase();
		const tag = document
			.getElementById("tagFilter")
			.value.toLowerCase();
		const results = document.getElementById("searchResults");

		if (!searchData) {
			results.innerHTML = '<div class="search-no-results">Loading...</div>';
			return;
		}

		if (!query && !category && !difficulty && !tag) {
			showSearchHint();
			return;
		}

		const filtered = searchData.filter((post) => {
			const matchesQuery =
				!query ||
				post.title.toLowerCase().includes(query) ||
				(post.content && post.content.toLowerCase().includes(query)) ||
				(post.tags && post.tags.some((t) => t.toLowerCase().includes(query))) ||
				(post.difficulty && post.difficulty.toLowerCase().includes(query));

			const matchesCategory =
				!category ||
				(post.category && post.category.toLowerCase() === category);

			const matchesDifficulty =
				!difficulty ||
				(post.difficulty && post.difficulty.toLowerCase() === difficulty);

			const matchesTag =
				!tag ||
				(post.tags && post.tags.some((t) => t.toLowerCase() === tag));

			return matchesQuery && matchesCategory && matchesDifficulty && matchesTag;
		});

		if (filtered.length === 0) {
			results.innerHTML =
				'<div class="search-no-results">No results found</div>';
			return;
		}

		results.innerHTML = filtered
			.map(
				(post) => `
			<a href="${post.url}" class="search-result-item">
				<div class="search-result-title">${escapeHtml(post.title)}</div>
				<div class="search-result-meta">
					<span class="search-result-date">${post.date}</span>
					${
						post.tags
							? post.tags
									.slice(0, 3)
									.map((t) => `<span class="tag">${escapeHtml(t)}</span>`)
									.join("")
							: ""
					}
					${
						post.difficulty
							? `<span class="difficulty difficulty-${post.difficulty}">${post.difficulty}</span>`
							: ""
					}
				</div>
				<div class="search-result-excerpt">${escapeHtml(post.content || "")}</div>
			</a>
		`
			)
			.join("");
	}

	function escapeHtml(text) {
		const div = document.createElement("div");
		div.textContent = text;
		return div.innerHTML;
	}

	document.addEventListener("DOMContentLoaded", function () {
		const searchInput = document.getElementById("searchInput");
		const categoryFilter = document.getElementById("categoryFilter");
		const difficultyFilter = document.getElementById("difficultyFilter");
		const tagFilter = document.getElementById("tagFilter");
		const overlay = document.getElementById("searchOverlay");

		if (searchInput) {
			searchInput.addEventListener("input", performSearch);
		}
		if (categoryFilter) {
			categoryFilter.addEventListener("change", performSearch);
		}
		if (difficultyFilter) {
			difficultyFilter.addEventListener("change", performSearch);
		}
		if (tagFilter) {
			tagFilter.addEventListener("change", performSearch);
		}
		if (overlay) {
			overlay.addEventListener("click", function (e) {
				if (e.target === overlay) {
					toggleSearch();
				}
			});
		}

		// Keyboard shortcut: Ctrl/Cmd + K to open search
		document.addEventListener("keydown", function (e) {
			if ((e.ctrlKey || e.metaKey) && e.key === "k") {
				e.preventDefault();
				toggleSearch();
			}
			if (
				e.key === "Escape" &&
				overlay &&
				overlay.classList.contains("active")
			) {
				toggleSearch();
			}
		});
	});
</script>
